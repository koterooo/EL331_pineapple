<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KWIC Web App</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>KWIC Web App</h1>

    {% set sel_type = request.form.get('search_type','token') %}
    {% set tgt_val  = request.form.get('target','') %}

    <form method="post" enctype="multipart/form-data">
      <!-- 1. Search type -->
      <label>Search type:<br>
        <select name="search_type" id="search_type" onchange="updateTargetInput()">
          <option value="token"  {% if sel_type=='token'  %}selected{% endif %}>Token</option>
          <option value="pos"    {% if sel_type=='pos'    %}selected{% endif %}>Part of Speech</option>
          <option value="entity" {% if sel_type=='entity' %}selected{% endif %}>Named Entity</option>
        </select>
      </label>

      <!-- 2. Target input -->
      <div id="token_input" style="display:{{ 'block' if sel_type=='token' else 'none' }};">
        <label>Target word(s):<br>
          <input type="text" name="target" id="target_token" value="{{ tgt_val if sel_type=='token' else '' }}">
        </label>
      </div>

      <div id="pos_input" style="display:{{ 'block' if sel_type=='pos' else 'none' }};">
        <label>POS tag:<br>
          <select name="target" id="target_pos">
            {% for pos in pos_tags %}
              <option value="{{ pos }}" {% if sel_type=='pos' and tgt_val==pos %}selected{% endif %}>{{ pos }}</option>
            {% endfor %}
          </select>
        </label>
      </div>

      <div id="ent_input" style="display:{{ 'block' if sel_type=='entity' else 'none' }};">
        <label>Entity label:<br>
          <select name="target" id="target_ent">
            {% for ent in ent_labels %}
              <option value="{{ ent }}" {% if sel_type=='entity' and tgt_val==ent %}selected{% endif %}>{{ ent }}</option>
            {% endfor %}
          </select>
        </label>
      </div>

      <!-- 3. Parameters -->
      <label>Context window size:
        <input type="number" name="window" value="{{ request.form.get('window',5) }}" min="1" max="20">
      </label>

      <label>Sort results by:
        <select name="sort_mode">
          {% for opt,label in [('sequential','Document Order'), ('token_freq','Most Frequent Token'), ('pos_freq','Most Frequent POS')] %}
            <option value="{{ opt }}" {% if request.form.get('sort_mode','sequential')==opt %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </label>

      <!-- 4. Text and file upload -->
      <label>Text input:<br>
        <textarea name="text" rows="10" placeholder="Enter your text or upload a .txt file...">{{ request.form.get('text','') }}</textarea>
      </label>

      <label>Upload .txt file (text corpus):
        <input type="file" name="file" accept=".txt">
      </label>

      <button type="submit">Run KWIC Search</button>
    </form>

    {% if result %}
      <h2>KWIC Results</h2>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>Left Context</th><th>Keyword</th><th>Right Context</th></tr></thead>
          <tbody>
            {% for item in result %}
              <tr>
                <td class="left">{{ item.left }}</td>
                <td class="mid">{{ item.mid }}</td>
                <td class="right">{{ item.right }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

    {% if patterns %}
      <h3>Most Frequent Next-Token Patterns</h3>
      <ul>
        {% for pat, cnt in patterns %}
          <li>{{ pat }} â€“ {{ cnt }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>

  <script>
    function updateTargetInput(){
      const type = document.getElementById('search_type').value;
      const divs = {
        token:  document.getElementById('token_input'),
        pos:    document.getElementById('pos_input'),
        entity: document.getElementById('ent_input')
      };
      const inputs = {
        token:  document.getElementById('target_token'),
        pos:    document.getElementById('target_pos'),
        entity: document.getElementById('target_ent')
      };
      for (let key in divs){
        const show = (key === type);
        divs[key].style.display = show ? 'block' : 'none';
        inputs[key].disabled    = !show;
      }
    }
    document.addEventListener('DOMContentLoaded', updateTargetInput);
  </script>
</body>
</html>