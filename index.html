<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>KWIC Explorer (PyScript)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap (for quick styling) -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

<!-- PyScript 2025-05:  *type="module"* is REQUIRED so that the browser
     treats core.js as an ES-module; otherwise you get an “export…” error -->
<link rel="stylesheet"
      href="https://pyscript.net/releases/2025.5.1/core.css">
<script type="module"
        src="https://pyscript.net/releases/2025.5.1/core.js"></script>

<!-- Declare pure-Python package(s) -->
<py-config>
  packages = ["nltk==3.8.1"]
</py-config>

<style>
  textarea{resize:vertical} pre{white-space:pre-wrap;word-break:break-word}
  .cyan{color:#00bcd4;font-weight:700}.yellow{color:#f5c400;font-weight:700}
  .red{color:#e91e63;font-weight:700}.green{color:#4caf50;font-weight:700}
  .blue{color:#2196f3;font-weight:700}.magenta{color:#9c27b0;font-weight:700}
  .grey{color:#607d8b;font-weight:700}.white{color:#fafafa;font-weight:700}
</style>
</head>

<body class="container my-4">
<h1 class="mb-3">KWIC Explorer <small class="text-muted fs-6">(PyScript)</small></h1>

<!-- Status -->
<div id="status" class="alert alert-info small">Loading Python runtime&hellip;</div>

<!-- Text to analyse -->
<div class="mb-3">
  <label class="form-label fw-bold" for="text">Text</label>
  <textarea id="text" class="form-control" rows="8"
            placeholder="Paste or type text here (a sample will be used if blank)."></textarea>
</div>

<!-- Parameters -->
<div class="row g-3">
  <div class="col-md-2">
    <label class="form-label">Search mode</label>
    <select id="mode" class="form-select">
      <option value="token" selected>token</option>
      <option value="pos">POS</option>
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Target</label>
    <input id="target" class="form-control" placeholder="e.g. banana / NN">
  </div>
  <div class="col-md-2">
    <label class="form-label">Window (±)</label>
    <input id="window" type="number" class="form-control" value="5" min="1">
  </div>
  <div class="col-md-2">
    <label class="form-label">Highlight colour</label>
    <select id="color" class="form-select">
      <option>cyan</option><option>yellow</option><option>red</option>
      <option>green</option><option>blue</option><option>magenta</option>
      <option>grey</option><option>white</option>
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Sort order</label>
    <select id="sort" class="form-select">
      <option value="sequential">sequential</option>
      <option value="token_freq">token freq</option>
      <option value="pos_freq">POS freq</option>
    </select>
  </div>
</div>

<button id="run" class="btn btn-primary mt-4">Run KWIC Search</button>

<hr class="my-4">
<h2 class="h4">Result</h2>
<pre id="output" class="border rounded p-3 bg-light small"></pre>

<!-- --------------------  PyScript  -------------------- -->
<script type="py">
"""
KWIC Explorer   –   browser-only (PyScript + Pyodide)
This block runs INSIDE the Python runtime.
"""
import io, html, urllib.request
import js
from pyodide.ffi import create_proxy
from pyodide.http import open_url

# ------------------------------------------------------------------
# WORK-AROUND:  make nltk.download() work inside Pyodide / PyScript
# ------------------------------------------------------------------
def _urlopen_via_fetch(url, *args, **kwargs):
    """Replace urllib.request.urlopen with Pyodide's fetch-based open_url."""
    # open_url returns a FetchResponse; we convert its bytes to a BytesIO
    resp_bytes = open_url(url).bytes()
    return io.BytesIO(resp_bytes)

urllib.request.urlopen = _urlopen_via_fetch  # ← monkey-patch

# ------------------------------------------------------------------
# Standard nltk imports AFTER patch, so the downloader picks it up
# ------------------------------------------------------------------
import nltk

# Download required resources – will now succeed via patched urlopen
nltk.download("punkt", quiet=True)
nltk.download("averaged_perceptron_tagger", quiet=True)

# ------------------------------------------------------------------
# KWIC helpers
# ------------------------------------------------------------------
def highlight(txt: str, colour: str) -> str:
    return f'<span class="{colour}">{html.escape(txt)}</span>'

def kwic(text: str, target: str, window: int = 5,
         mode: str = "token", colour: str = "cyan",
         sort: str = "sequential") -> str:
    tokens = nltk.word_tokenize(text.replace("\n", " "))
    tags   = [tag for _, tag in nltk.pos_tag(tokens, tagset="universal")] if mode == "pos" else []

    tgt = target.split(); n = len(tgt)
    matches: list[tuple[int, int]] = []

    if mode == "token":
        lo_tokens = [t.lower() for t in tokens]
        lo_target = [w.lower() for w in tgt]
        for i in range(len(tokens) - n + 1):
            if lo_tokens[i:i+n] == lo_target:
                matches.append((i, n))
    elif mode == "pos":
        for i in range(len(tags) - n + 1):
            if tags[i:i+n] == tgt:
                matches.append((i, n))

    if not matches:
        return "<em>No matches found.</em>"

    lines = []
    for idx, length in matches:
        left  = " ".join(tokens[max(0, idx-window):idx])
        mid   = " ".join(tokens[idx:idx+length])
        right = " ".join(tokens[idx+length:idx+length+window])
        lines.append(f'{html.escape(left):>40}  {highlight(mid, colour):^15}  {html.escape(right):<40}')

    if sort == "token_freq":
        lines.sort(key=lambda s: s.lower().split()[41])
    elif sort == "pos_freq" and mode == "pos":
        lines.sort(key=lambda s: s.split()[41])

    header = f"<strong>=== KWIC ({html.escape(mode)}) – «{html.escape(target)}» ===</strong><br>"
    return header + "<br>".join(lines)

# ------------------------------------------------------------------
# Button event handler
# ------------------------------------------------------------------
def run_kwic(event):
    doc = js.document
    text   = doc.getElementById("text").value or "A banana is an elongated, edible fruit that…"
    target = doc.getElementById("target").value or "banana"
    window = int(doc.getElementById("window").value or 5)
    mode   = doc.getElementById("mode").value
    colour = doc.getElementById("color").value
    sort   = doc.getElementById("sort").value

    doc.getElementById("output").innerHTML = kwic(text, target, window, mode, colour, sort)
    doc.getElementById("status").innerText = "Done."

# Bind click-handler to the “Run KWIC Search” button
js.document.getElementById("run").addEventListener("click", create_proxy(run_kwic))
js.document.getElementById("status").innerText = "Ready! PyScript runtime loaded."
</script>
</body>
</html>
